<!DOCTYPE html>
<html>
<head>
    <title>The Pineapple Express Tracker</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #e0f7fa; }
        
        /* The Dashboard Overlay */
        #bruce-dashboard {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            border: 2px solid #0288d1;
        }

        h1 { margin: 0 0 10px 0; color: #01579b; font-size: 24px; text-align: center; }
        .status-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .label { font-weight: bold; color: #555; }
        .value { color: #000; font-weight: bold; }

        /* The Bruce Counter */
        .bruce-meter {
            background: #263238;
            color: #4fc3f7;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-top: 15px;
            font-family: 'Courier New', Courier, monospace;
        }
        .bruce-count { font-size: 32px; font-weight: bold; display: block; }
        .bruce-label { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }

        /* Map Container */
        #map { height: 100vh; width: 100%; }

        /* Fun styling for the connecting line */
        .status-active { color: #2e7d32; } /* Green for moving */
        .status-docked { color: #c62828; } /* Red for stopped */
    </style>
</head>
<body>

    <div id="bruce-dashboard">
        <h1>üõ≥Ô∏èüçç The Pineapple Express</h1>
        <hr>
        <div class="status-row">
            <span class="label">Current Status:</span>
            <span class="value" id="status-text">Locating Bruce...</span>
        </div>
        <div class="status-row">
            <span class="label">Trip Day:</span>
            <span class="value" id="trip-day">--</span>
        </div>
        <div class="status-row">
            <span class="label">Destination:</span>
            <span class="value" id="next-stop">--</span>
        </div>
        
        <div class="bruce-meter">
            <span class="bruce-count" id="bruce-counter">0000</span>
            <span class="bruce-label">Total Pineapples üçç</span>
        </div>
        
        <div style="margin-top:10px; font-size:12px; text-align:center; color:#888;">
            *Live estimates based on itinerary.
        </div>
    </div>

    <div id="map"></div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCUefb8ZLoq9mlu4NwTgt0SkZCHxH3QnOI&callback=initMap&v=weekly" async></script>

    <script>
        let map;
        let shipMarker;
        let pathLine;
        
        // --- 1. THE DATA (Digitized from your image) ---
        // Times are in ISO format (UTC or Local? Assuming NZ/AU local time for simplicity, 
        // using ISO strings ensures logic holds up). 
        // We use a helper to generate dates relative to the year 2026.
        
        function getDate(day, time) {
            // Format: 2026-01-DDTHH:MM:00
            // Note: Months are 0-indexed in JS Date constructor, but string parsing is easier here.
            // Jan = 01, Feb = 02.
            return new Date(`2026-${day}T${time}:00+13:00`).getTime(); // Assuming NZ Time (+13 in Jan DST)
        }

        // The Itinerary
        const schedule = [
            { name: "Auckland",         lat: -36.8485, lng: 174.7633, type: "stop", arrival: null,                   departure: getDate("01-20", "18:00") },
            { name: "Bay of Islands",   lat: -35.2621, lng: 174.1220, type: "stop", arrival: getDate("01-21", "07:00"), departure: getDate("01-21", "19:00") },
            { name: "Napier",           lat: -39.4928, lng: 176.9120, type: "stop", arrival: getDate("01-23", "08:00"), departure: getDate("01-23", "17:00") },
            { name: "Wellington",       lat: -41.2865, lng: 174.7762, type: "stop", arrival: getDate("01-24", "08:00"), departure: getDate("01-24", "19:00") },
            { name: "Nelson",           lat: -41.2706, lng: 173.2840, type: "stop", arrival: getDate("01-25", "08:00"), departure: getDate("01-25", "20:00") },
            { name: "Picton",           lat: -41.2930, lng: 174.0079, type: "stop", arrival: getDate("01-26", "08:00"), departure: getDate("01-26", "16:00") },
            { name: "Christchurch",     lat: -43.6017, lng: 172.7188, type: "stop", arrival: getDate("01-27", "07:00"), departure: getDate("01-27", "17:00") },
            { name: "Dunedin",          lat: -45.8159, lng: 170.6272, type: "stop", arrival: getDate("01-28", "07:30"), departure: getDate("01-28", "16:00") },
            { name: "Fiordland NP",     lat: -44.6414, lng: 167.8974, type: "stop", arrival: getDate("01-29", "16:00"), departure: getDate("01-29", "19:00") },
            { name: "Hobart",           lat: -42.8821, lng: 147.3272, type: "stop", arrival: getDate("02-01", "08:00"), departure: getDate("02-02", "18:00") },
            { name: "Eden",             lat: -37.0617, lng: 149.9048, type: "stop", arrival: getDate("02-04", "08:00"), departure: getDate("02-04", "15:00") },
            { name: "Sydney",           lat: -33.8688, lng: 151.2093, type: "stop", arrival: getDate("02-05", "06:30"), departure: null }
        ];

        // --- 2. INITIALIZE MAP ---
        function initMap() {
            // Center roughly between NZ and Aus
            const mapOptions = {
                zoom: 5,
                center: { lat: -40.0, lng: 165.0 },
                mapId: 'DEMO_MAP_ID', // Required for advanced markers if you use them
                disableDefaultUI: false
            };

            map = new google.maps.Map(document.getElementById("map"), mapOptions);

            // Draw the full route line (Grey, static)
            const routeCoords = schedule.map(port => ({ lat: port.lat, lng: port.lng }));
            const routePath = new google.maps.Polyline({
                path: routeCoords,
                geodesic: true,
                strokeColor: "#FF0000",
                strokeOpacity: 0.4,
                strokeWeight: 2,
            });
            routePath.setMap(map);

            // Create Ship Marker (Bruce Express)
    shipMarker = new google.maps.Marker({
        position: routeCoords[0],
        map: map,
        title: "The Pineapple Express",
        icon: {
            // REPLACE THE URL BELOW with your own image link or file name!
            url: "icon.png", 
            scaledSize: new google.maps.Size(160, 160), // Width, Height (in pixels)
            anchor: new google.maps.Point(30, 30)     // The center of the image (half of width, half of height)
        },
        animation: google.maps.Animation.DROP
    });

            // Start the update loop
            setInterval(updateShipStatus, 1000); // Updates every second
            updateShipStatus(); // Run immediately
        }

        // --- 3. THE LOGIC ---
        function updateShipStatus() {
            // FOR TESTING: To see it work right now, uncomment the line below and set a fake date!
            // const now = new Date("2026-01-22T12:00:00+13:00").getTime(); 
            
            const now = Date.now(); 
            const tripStart = schedule[0].departure;
            const tripEnd = schedule[schedule.length-1].arrival;

            let currentPos = { lat: 0, lng: 0 };
            let heading = 0;
            let statusMsg = "";
            let nextStopName = "";
            let tripDay = 0;
            let percentJourney = 0;

            if (now < tripStart) {
                // Before trip
                statusMsg = "Awaiting Departure";
                currentPos = { lat: schedule[0].lat, lng: schedule[0].lng };
                nextStopName = schedule[1].name;
                tripDay = 0;
            } else if (now > tripEnd) {
                // After trip
                statusMsg = "Journey Complete!";
                currentPos = { lat: schedule[schedule.length-1].lat, lng: schedule[schedule.length-1].lng };
                nextStopName = "Home";
                tripDay = 16;
                percentJourney = 100;
            } else {
                // DURING TRIP
                // Find which segment we are in
                tripDay = Math.ceil((now - tripStart) / (1000 * 60 * 60 * 24));
                
                // Calculate percentage of total time for the Bruce Counter
                const totalDuration = tripEnd - tripStart;
                const elapsed = now - tripStart;
                percentJourney = (elapsed / totalDuration) * 100;

                let foundSegment = false;

                for (let i = 0; i < schedule.length - 1; i++) {
                    const currentPort = schedule[i];
                    const nextPort = schedule[i + 1];

                    // CASE A: Are we AT the current port? (Between arrival and departure)
                    if (currentPort.arrival && now >= currentPort.arrival && now <= currentPort.departure) {
                        currentPos = { lat: currentPort.lat, lng: currentPort.lng };
                        statusMsg = `Docked: ${currentPort.name}`;
                        nextStopName = nextPort.name;
                        foundSegment = true;
                        break;
                    }

                    // CASE B: Are we SAILING between current port and next port?
                    // (After current departure, before next arrival)
                    if (now > currentPort.departure && now < nextPort.arrival) {
                        statusMsg = "At Sea üåä";
                        nextStopName = nextPort.name;

                        // Calculate interpolation (0.0 to 1.0)
                        const sailingDuration = nextPort.arrival - currentPort.departure;
                        const timeSailed = now - currentPort.departure;
                        const progress = timeSailed / sailingDuration;

                        // Linear interpolation of coordinates
                        const lat = currentPort.lat + (nextPort.lat - currentPort.lat) * progress;
                        const lng = currentPort.lng + (nextPort.lng - currentPort.lng) * progress;
                        currentPos = { lat: lat, lng: lng };

                        // Calculate heading for the arrow icon
                        heading = getHeading(currentPort.lat, currentPort.lng, nextPort.lat, nextPort.lng);
                        foundSegment = true;
                        break;
                    }
                }
            }

            // Update UI
            // Update UI
    if(shipMarker) {
        shipMarker.setPosition(currentPos);
        
        // We removed the rotation code here because images usually stay upright!
        
        map.panTo(currentPos);
    }

            document.getElementById("status-text").innerText = statusMsg;
            document.getElementById("status-text").className = statusMsg.includes("Docked") ? "value status-docked" : "value status-active";
            document.getElementById("next-stop").innerText = nextStopName;
            document.getElementById("trip-day").innerText = tripDay > 0 ? `Day ${tripDay}` : "Soon";
            
            // Update Bruce Counter (Simulated Miles based on % of trip completed)
            // Lets assume total trip is roughly 3000 miles
            const totalMiles = 2100; 
            const bruces = Math.floor((percentJourney / 100) * totalMiles);
            document.getElementById("bruce-counter").innerText = bruces.toString().padStart(4, '0');
        }

        // Helper to calculate angle between two coords
        function getHeading(lat1, lng1, lat2, lng2) {
            const toRad = Math.PI / 180;
            const startLat = lat1 * toRad;
            const startLng = lng1 * toRad;
            const destLat = lat2 * toRad;
            const destLng = lng2 * toRad;

            const y = Math.sin(destLng - startLng) * Math.cos(destLat);
            const x = Math.cos(startLat) * Math.sin(destLat) -
                      Math.sin(startLat) * Math.cos(destLat) * Math.cos(destLng - startLng);
            let brng = Math.atan2(y, x);
            brng = brng * 180 / Math.PI;
            return (brng + 360) % 360;
        }
    </script>
</body>
</html>